<!-- prettier-ignore -->
<!DOCTYPE html>
<html>
  <body>
    <canvas id="canvas" width="600px" height="400px">Here is canvas</canvas>
  </body>
  <script type="text/javascript">
    // å¤šåˆ†è¾¨ç‡å¤„ç†
    function highres() {
      // Get the DPR and size of the canvas
      const dpr = window.devicePixelRatio;
      const rect = canvas.getBoundingClientRect();

      // Set the "actual" size of the canvas
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;

      // Scale the context to ensure correct drawing operations
      ctx.scale(dpr, dpr);

      // Set the "drawn" size of the canvas
      canvas.style.width = `${rect.width}px`;
      canvas.style.height = `${rect.height}px`;
    }

    // ç”ŸæˆCanvasçš„å¿«ç…§
    function Flash(canvas) {
      let imgURI = canvas.toDataURL("image/png");
        // or jpeg: canvas.toDataURL("image/jpeg", quality)
        // or blob: canvas.toBlob(_callBack, type, quality)

      let ima = document.createElement("img");
      ima.src = imgURI;
      document.body.appendChild(ima);
    }

    // è·å–å±€éƒ¨å›¾åƒæ•°æ®å¹¶ä¿®æ”¹
    function ImgData(ctx) {
      let imgData = ctx.getImageData(0, 0, 100, 100); //Location(x,y)+Size(x,y)
        // or just create one: ctx.createImageData(width, height)
      let data = imgData.data;  //Uint8ClampedArray
      let row = 10,column=10, pixelPos = row * (imgData.width * 4) + column * 4; // è¦å¤„ç†çš„å›¾ç‰‡pixelä½ç½®
      data[pixelPos] = data[pixelPos + 1];  // Ré€šé“ = Gé€šé“
      img.data = data;
      ctx.putImageData(imgData, 0, 0); //æ”¾å›å»
    }

    // åŠ¨ç”»æ­¥éª¤
    // åŠ¨ç”»å°±æ˜¯æ¯æ¬¡å¾ªç¯çš„æ—¶å€™paintæ”¹åŠ¨åˆ°çš„å†…å®¹
    function animation(canvas) {
      // 1. clean moving part
      canvas.clearRect(0, 0, canvas.width, canvas.height);
      // 1.1 trailing effect
      canvas.fillStyle = 'rgba(255, 255, 255, 0.3)';  //more transparent longer trailing
      canvas.fillRect(0, 0, canvas.width, canvas.height);
      // 2. save previous state
      canvas.save();
      // 3. draw the animated contents
      canvas.fillRect();
      // 4. restore state
      canvas.restore();
      // 5. trigger next frame
      window.requestAnimationFrame(animation);
    }

    // canvas ç‰ˆæœ¬çš„åŒç¼“å†²(æ”¯æŒwebworker)
    function offscreen(canvas) {
      // sample and unoptimized
      canvas.offscreenCanvas = document.createElement('canvas');
      canvas.offscreenCanvas.width = canvas.width;
      canvas.offscreenCanvas.height = canvas.height;
      canvas.getContext('2d').drawImage(canvas.offscreenCanvas, 0, 0);

      // sync, offscreenCanvas åšåŒç¼“å†², canvas ä¹Ÿå¯åŒæ­¥è¿ç®—
      const screenCtx = canvas.getContext('bitmaprenderer');
      const offscreenSync = new OffscreenCanvas(canvas.width, canvas.height);
      screenCtx.transferFromImageBitmap(offscreenSync.transferToImageBitmap());

      // async, æŠŠè¿ç®—å…¨éƒ¨äº¤ç»™ offscreenCanvas, canvas ä»…å±•ç¤º
      const offscreen = canvas.transferControlToOffscreen();
      const worker = new Worker('./canvas_worker.js');
      worker.postMessage({ offscreen }, [offscreen]);
      // in `canvas_worker.js`
      self.onmessage = (evt) => {
        const canvas = evt.data.offscreen;
        const render = () => requestAnimationFrame(render);
        requestAnimationFrame(render);
      }
    }
  </script>
  <script type="text/javascript">
    (function () {
      var canvas = document.querySelector("#canvas");

      //æ£€æµ‹æ˜¯å¦æ”¯æŒcanvas
      if (canvas.getContext) {

        let ctx = canvas.getContext("2d"); //2dåæ ‡åŸç‚¹åŸºäºCanvasçš„å·¦ä¸Šè§’. ä½†æ˜¯åŸç‚¹ä½ç½®å¯ä»¥ä¿®æ”¹
        //2då¯ä»¥ç›´æ¥ç”»: çŸ©å½¢, è·¯å¾„, è´å¡å°”æ›²çº¿, æ–‡æœ¬, å›¾åƒ, é˜´å½±, æ¸å˜, Boolåˆæˆ
        // style éƒ½å¯ä»¥è®¾ç½® rgba/hex/gradient/pattern
        // å¦‚æœç”»å‡ºçš„çº¿çš„ç‚¹è½åœ¨å°æ•°ä½ç½®ï¼Œä¼šå¯¼è‡´å›¾å½¢å˜å¾—æ¨¡ç³Š(sub-pixelå¡«å……åŠé€æ˜é¢œè‰²)
        // å¦‚æœä¸€æ¬¡ç»˜åˆ¶æ—¶æœ‰alphaé‡å ï¼Œcanvasæœ‰è‡ªåŠ¨çš„alphaæ··åˆ
        // æœ‰stokeæ•ˆæœçš„è‚¯å®šæœ‰å¯¹åº”çš„fill

        // ç”»ç¬”åŠç”»çº¿æ•ˆæœ
        const lineGrad = ctx.createLinearGradient(0, 0, 0, 150);
        lineGrad.addColorStop(0.25, '#fff');
        const ptrn = ctx.createPattern(Image, 'repeat');
        ctx.strokeStyle = lineGrad; //æè¾¹ç”»ç¬”
        ctx.fillStyle = ptrn; //å¡«å……ç”»ç¬”
        ctx.lineCap = 'butt'; //å¯ä»¥è®¾ç½®çº¿çš„è¡¨ç°(çº¿ç«¯ã€å®½åº¦ã€é¢œè‰²ã€dashã€æ‹å¼¯æ•ˆæœç­‰)
        ctx.shadowColor = 'rgba(0,0,0,0.5)';  //å¯ä»¥è®¾ç½®é˜´å½±è¡¨ç°(Blurã€Offsetã€Colorç­‰)
        ctx.globalCompositeOperation = 'source-over'; //å›¾åƒboolæ··åˆ

        ctx.fillRect(x, y, width, hight); // draw immediately.
        ctx.clearRect(55, 55, 5, 5);  // æ¸…ç©ºè¯¥ä½ç½®ç»˜åˆ¶çš„å†…å®¹
        ctx.moveTo(10, 10); // ç§»åŠ¨ğŸ–Œï¸

        // ç”»å¤æ‚å‡ ä½•
        ctx.beginPath();
        ctx.moveTo(30, 30); // point, å®é™…ä¸Šåº”è¯¥å«movePaintTo
        ctx.lineTo(20, 20); // line (connected point)
        ctx.closePath();  // è¿æ¥æœ€åä¸€ä¸ªç‚¹å’Œç¬¬ä¸€ä¸ªç‚¹
        ctx.stroke(); // å¡«å……çº¿, æˆ–è€…ç”¨ fill å¡«å……å°é—­å›¾å½¢
        ctx.clip(); // ä½¿ç”¨è¯¥pathç»„æˆä¸€ä¸ªmaskï¼Œä¹‹åçš„å†…å®¹åœ¨pathåœˆå®šèŒƒå›´å†…çš„æ‰ä¼šç”»ä¸Šå»(clipåº”è¯¥ç”¨save/restoreä¿å­˜ä¸Šä¸‹æ–‡åå†å˜åŠ¨)

        const rect = new Path2D(); // Pathå¯¹è±¡, æ–¹ä¾¿ç®¡ç†Path, è€Œä¸”å¯ä»¥ç”¨svgçš„path
        rect.arc(100, 35, 25, 0, 2 * Math.PI);  // ä¹ŸåŒ…å«å¸¸è§„contextç”»pathçš„å·¥å…·
        rect.addPath(new Path(), new DOMMatrix());  // å¯ä»¥æ–¹ä¾¿ç»„åˆå˜å½¢Path

        // ç”»å­—. Canvasä¸­å­—ä½“æ˜¯bitmapï¼Œæ‰€ä»¥ç¼©æ”¾ä¼šå˜æ¨¡ç³Š
        ctx.font = "20px Times New Roman";
        ctx.fillStyle = "Black";
        ctx.fillText("Sample String", 5, 30);
        const textMetrics = ctx.measureText("Text");  //è·å–æ–‡å­—åœ¨canvasä¸Šæ¸²æŸ“åå¯èƒ½çš„ä¿¡æ¯(width,height,ä½ç½®ä¿¡æ¯ç­‰)

        // ç”»å›¾
        ctx.drawImage(image); //å¯ä»¥è®¾ç½®å›¾ç‰‡çš„æ‹‰ä¼¸(æŒ‡å®šå®½åº¦ã€é•¿åº¦å³å¯), è£åˆ‡(æŒ‡å®šè£åˆ‡ä½ç½®å’Œé•¿å®½)
        ctx.imageSmoothingEnabled = true; //å›¾ç‰‡æ‹‰ä¼¸æ—¶æ˜¯å¦å¹³æ»‘

        // canvasä¸Šä¸‹æ–‡è½¬æ¢
        ctx.save(); //å°†ç°åœ¨canvasçš„è®¾ç½®å‹å…¥æ ˆä¸­(ç”¨äºä¿å­˜: fillColor,globalAlpha,originç­‰)
        ctx.restore(); //ä»æ ˆä¸­å¼¹å‡º(ä¸ä¼šæ”¹åŠ¨canvasçš„æ˜¾ç¤ºå†…å®¹, åªä¼šæ”¹åŠ¨å¯¹åº”çš„è®¾ç½®)
        
        // å˜æ¢
        ctx.translate(0, 0);  //æ›´æ”¹åŸç‚¹ä½ç½®(å¯ä»¥çœ‹ä½œæ·»åŠ äº†ä¸€ä¸ªlocalSpaceã€‚ä¹‹åå°±å¯ä»¥åŸºäºè¯¥åŸç‚¹ç»˜åˆ¶)
        ctx.rotate((Math.PI / 180) * degrees); //æ—‹è½¬åº§æ ‡(localSpaceçš„åº§æ ‡)
        ctx.scaling(xS, yS);  //å¯ç”¨äºæ‹‰ä¼¸æˆ–é•œåƒï¼Œå¦‚æ¨ªåº§æ ‡é•œåƒ: scale(-1,1), æ¨ªåº§æ ‡æ‹‰ä¼¸2å€: scale(2,1)
        ctx.transform(cos, sin, -sin, cos, 0, 0); //å¯¹å½“å‰å˜æ¢çŸ©é˜µåº”ç”¨å˜æ¢çŸ©é˜µ
        ctx.setTransform(-1, 0, 0, 1, 100, 100);  //æœ€ç»ˆå½¢æ€å˜æ¢çŸ©é˜µ
        ctx.resetTransform(); // === ctx.setTransform(1, 0, 0, 1, 0, 0);

        window.context = ctx;
      }
    })();
  </script>
</html>
