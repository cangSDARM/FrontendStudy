# 系统架构

CAP（C 一致性、A 可用性、P 分区容错性。P 是必须的，因为网络算是分区且必须容错）

- CP 系统: 单写多读
- AP 系统: 多写多读，但会有过期数据

## 可扩展性

## 性能

可用指标:

- 响应时间: 指从发出请求开始到收到最后响应数据所需要的时间。**反映系统快慢**
  - 延迟
- 并发数: 系统同时处理的请求数。**反映系统负载**
- 吞吐量: 单位时间内，系统处理请求的数量。**体现系统处理能力**
  - HTTP 请求数: HPS (http-request per sec)
  - 每秒事务数: TPS
  - 每秒查询数: QPS

实践:

- 纵向性能
  - 异步(MQ)设计
  - 缓存层
  - 代码优化
- 横向性能
  - 分布式(数据库、MQ、文件、服务器)
  - 负载均衡
- 性能监控

## 可用性

> 系统不会发生故障的概率<br>
> Reliability = uptime / (uptime + downtime)

一般说可用性是多少个 9: 2 个 9 = 99%; 3 个 9 = 99.9%

可用性一般用于定义 SLO(等效意义)

- SLA = Service Level Agreement = 服务水平协议(对外承诺, SLO 的 try/catch)
- SLO = Service Level Objective = 服务水平目标(对内产品目标)
- SLI = Services Level Indicator = 服务水平指标(对内产品服务质量评价指标)

实践:

- 提供系统冗余性
  - 数据库主从复制
- 增加容错可能性
  - 失败隔离
  - 限流降级
- 增加可用性监控、日志
- 无状态 Web 层(每个 Web 服务器不存储用户状态，而通过统一的位置访问)

## 安全性

## 经典系统

### 经典 CP

Client -> Coordinator --> Servers

正常读写时:

1. Coordinator: 单节点
   - 使用 Quorum 共识仲裁保证内容一致: N 个副本读需要 R 个服务器回复；写需要 W 个服务器回复
     - 使用 Merkle 树保证复制内容一致性
     - 使用 Hybrid Logical Clocks 保证竞争的最终一致性
   - 使用一致性哈希映射 Server: 将哈希空间映射到服务器，删除服务器时只需要将对应空间重新映射到下一个；添加只需要将上一个的重新拆分到下一个
     - 映射不均匀通过"虚拟空间"解决: 二级映射，先将哈希空间均匀分布，然后再映射分布的到服务器
   - 使用服务发现选择 Server(如 ZooKeeper)
2. Servers
   - 写:
     - 使用 binlog 保证操作一致性: log 中会保存所有的写操作日志
     - 请求立即写入操作到 log，然后将数据写入 cache；cache 数据满后一次批量写入 disk
   - 读:
     - 数据如果在 cache 中则直接返回
     - 否则使用 bloom filter 从 disk 高效筛选

服务故障时:

1. Servers
   - gossip 协议检测故障
   - 暗示切换(hinted handof)解决临时宕机: 交给哈希空间中下一个服务器，上线后再恢复处理
