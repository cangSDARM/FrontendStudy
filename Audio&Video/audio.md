- [采集](#采集)
- [数模转换/编码](#数模转换编码)
  - [量化](#量化)
    - [遮蔽处理](#遮蔽处理)
  - [编码](#编码)
    - [格式化](#格式化)
- [封包](#封包)
- [传输](#传输)
  - [重采样](#重采样)
- [播放](#播放)
- [编解码格式](#编解码格式)
  - [PCM](#pcm)
    - [WAV](#wav)
  - [AAC](#aac)
    - [版本](#版本)
    - [格式](#格式)
  - [OPUS](#opus)
  - [Ogg](#ogg)

## 采集

```txt
         次声波         可听声波          超声波
听觉范围  -------┴--------------------┴----------→ F(Hz, 振荡次数/每秒)
              20Hz                 2kHz
发声范围             └------------┘
                   85Hz       1100Hz
```

音频模拟信号三要素：音调(频率的快慢)、音量(频率的幅度)、音色(谐波)

音频的主要频谱集中在低频段，高频段幅度很小，但很重要，决定了音质

## 数模转换/编码

要将一段音频从模拟信号转换为数字信号，包含如下三个步骤：

1. Sampling(采样)
   - 定义声道数，按照声道数接受多声道的信号
   - 定义采样率(采样速率, Hz)，按照采样率采样
     - 理论上来说采样率大于 40kHz 的音频可以称之为无损
     - 常用的有 44.1kHz, 48kHz, 50kHz, 96kHz
2. Quantization(量化)
   - 定义位深/采样大小(采样可舍入大小, bit)
     - 按照位深进行采样数据的舍入
     - 现有的有 8bit, 16bit, 32bit (32 以上对于人类根本没必要)
3. Coding(编码)
   - 定义大小端，音频通常为小端存储
   - 定义`帧长度 = 样本长度 * 声道数`，这样才能进行播放，以及对其他多媒体时间的匹配
   - 可以求得对应`码率/比特率(kbps) = 位深 * 采样率 * 声道数`。码率是动态的
   - 以及对应`大小(Mb) = 时长(s) * 码率 / 1024 / 8`

现有的几乎所有硬件默认转换为 [PCM 格式](#pcm)

### 量化

#### 遮蔽处理

有损压缩。

因为录制的音频可能包含人类听觉范围外的声音，以及一些干扰声音(遮蔽)，所以需要去掉

遮蔽包含

- 频域遮蔽
  - 一个强纯音会掩蔽在其附近同时发声的弱纯音，这种特性称为频域掩蔽
  - ![freq-masking](/assets/freq-masking.jpg)
- 时域遮蔽
  - 掩蔽效应发生在掩蔽声与被掩蔽声不同时出现时，又称异时掩蔽
  - 假设一个很响的声音后面紧跟着一个很弱的声音，而时间差在 200ms 之内，弱音就很难听到，相反在弱音后紧跟着一个很强的音，而时间在 50ms 之内，弱音也是很难听到
  - 时域通常会经过 MDCT 变换转为频域处理
  - ![time-masking](/assets/time-masking.jpg)

### 编码

可以是无损也可以是有损。

- VBR(Variable Bitrate, 动态码率)
- CBR(Constants Bit Rate, 固定码率)
  - 优点是压缩快，能被大多数软件和设备支持，缺点是占用空间相对大，效果不十分理想
  - 现已逐步被 VBR 的方式取代

#### 格式化

添加一些额外内容，以实现跳转播放、信息处理等

## 封包

## 传输

### 重采样

修改原始流的音频三元组(采样率、位深、声道数)称为重采样

`重采样输出样本数 = Math.ceil(输入样本数 / 输入采样率 * 输出采样率)`

## 播放

`一帧播放时间(毫秒) = 单帧样本数 * 1000 / 采样率` (单帧样本数是各种编解码格式预先定义好的)

## 编解码格式

一般除 PCM 外其他格式都是以 PCM 为输入(硬件输出的格式)

| 格式 |            常用库(有优先级)             |
| :--: | :-------------------------------------: |
| AAC  | fdk_aac/qaac(apple)/nero_aac/ffmpeg_aac |

![encoders](/assets/audio-encoders.png)

![bitrate](/assets/audio-encoders-bitrate.png)

### PCM

PCM(Pulse Code Modulation, 用数字表示的采样模拟信号)

不使用任何压缩技巧。(事实)标准无压缩音频流

PCM 帧长度为 2048

基于各个平台、版本要求，衍生出很多子格式，如 WAV、AVIF 等

#### WAV

将 PCM 流加上 WAV Header 即 WAV 格式

![WAV Header](/assets/wav-header.png)

### AAC

#### 版本

目标是取代 MP3 格式

- 采样率选择：8kHz ~ 96kHz，MP3 为 16kHz ~ 48kHz
- AAC 规定单帧长度为 1024，MP3 为 1152
- 声道数上限：48 个，MP3 在 MPEG-1 模式下为最多双声道，MPEG-2 模式下 5.1 声道

最早是基于 MPEG-2 标准，称为：MPEG-2 AAC。后来 MPEG-4 标准在原来基础上增加了一些新技术，称为：MPEG-4 AAC

```txt
┌---AAC------------------┐
| ┌---------------┐      |
| |               |      |
| | AAC LC + SBR  | + PS |
| |               |      |
| └--AAC HEv1-----┘      |
|      AAC HEv2          |
└------------------------┘
```

- AAC LC(Low Complexity)
  - LC 码率在 96kbps ~ 192kbps 之间
- AAC HEv1(High Efficiency)
  - AAC LC + SBR
    - SBR(Spectral Band Replication, 频段复制)
    - 有损压缩
    - 核心思想是按照频谱分别编码保存。低频编码为主，高频单独放大编码保存音质
- AAC HEv2
  - AAC HEV1 + PS
    - PS(Parametric Stereo, 参数立体声)
    - 是一种有损的音频压缩算法，可以进一步提高压缩率
    - 存储一个声道的全部信息，然后花很少的字节用参数描述另一个声道和它不同的地方

在低码率的情况下，AAC HEv1，AAC HEv2 编码后的音质要明显好于 AAC LC。而在码率较大后(128kbps)，其主观质量逐渐相同

#### 格式

- extradata
  - 在第一个头里，解码时先传输 extradata 信息，然后开始传输 raw data
  - 包含比特率、位深等信息
- ADIF
  - Audio Data Interchange Format
  - 只有一个头，其余后面都跟着 raw data
  - 仅能从开始处顺序一帧一帧解码，无法从中间位置解码
- ADTS
  - Audio Data Transport Stream
  - 每帧都带 7/9 字节头(9 字节包含 CRC 校验，但一般不做)
  - 方便跳播，从任何位置都可以直接进行解码
  - [含义解析](https://www.p23.nl/projects/aac-header/)
- LATM
  - Low-overhead MPEG-4 Audio TransportMultiplex
  - 每帧都带头，但传输时可以配置跳过头发送

### OPUS

### Ogg
