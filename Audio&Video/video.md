- [采集](#采集)
  - [色彩空间](#色彩空间)
    - [YUV](#yuv)
    - [YCbCr](#ycbcr)
- [编码](#编码)
- [封包](#封包)
- [传输](#传输)
- [播放](#播放)
  - [Web ▶️](#web-️)
- [编解码格式](#编解码格式)
  - [H.264](#h264)

## 采集

视频只是一帧帧的图片压缩而成

`视频码率 = 分辨率(宽 * 高) * 像素色深(bit, RGB 24bit) * 帧率`

### 色彩空间

通常视频采集、编码使用 YUV，播放用 RGB

#### YUV

Y 代表明度(方便兼容黑白电视)，UV 表示色彩及饱和度。
但实际上仅仅是 RGB 的经验权重转换结果

由于人对亮度敏感，对色彩不敏感
因此常见的[保存格式](https://fourcc.org/yuv.php)有

- YUV(4:4:4)
  - 同行 4 个像素存储 4 个 Y, 4 个 U, 4 个 V
- YUV422(4:2:2)
  - 大小是 RGB 的 2/3
  - 同行 4 个像素存储 4 个 Y, 2 个 U, 2 个 V(每两个相邻像素，一个丢弃 V，一个丢弃 U)
- YUV420(4:2:0)
  - _最普遍支持格式_，大小是 RGB 的 1/2
  - 由于每行相邻两个像素与下一行同位置的两个像素色彩差异不大
  - 两行 8 个像素存储 8 个 Y, 2 个 U, 2 个 V(同行两个像素只保留一个 U 数据，下一行只保留一个 V 数据)
  - 存储格式
    - ![yuv420-stored](/assets/yuv420-stored.png)
    - 都是先存 Y 分量，再处理 UV 分量
    - planar 平面模式
      - I420(先存 U)：YYYYYYYY UU VV
      - YV12(先存 V)：YYYYYYYY VV UU
    - packed 打包模式
      - NV12(UV)：YYYYYYYY UV UV
      - NV21(VU)：YYYYYYYY VU VU
- YUV411(4:1:1)
  - 同行 4 个像素存储 4 个 Y, 1 个 U, 1 个 V(每四个相邻像素，保留一个 V 和一个 U)

由于 UV 可能为负数或正数，为了图像能够显示这些分量的负值，一般会在分量计算公式之后加上一个偏移量，使得其颜色分量为正值。
比如，对于 8bit 表示一个分量的像素而言，其颜色分量的偏移量一般设置为 128=2^7

和 RGB 互转：

```txt
Y = 0.299R + 0.587G + 0.114B
U = -0.147R - 0.289G + 0.436B
V = 0.615R - 0.515G - 0.100B

R = Y + 1.140V
G = Y - 0.395U - 0.581V
B = Y + 2.032U
```

#### YCbCr

是 YUV 颜色空间的一种变体，仅是其各个分量的权重值稍有不同

和 RGB 互转：

```txt
Y = 0.299R + 0.587G + 0.144B
Cb = -0.169R - 0.331G + 0.500B
Cr = 0.500R - 0.419G - 0.081B

R = Y + 1.403Cr
G = Y - 0.344Cb - 0.714Cr
B = Y + 1.773Cb
```

## 编码

## 封包

## 传输

## 播放

硬解支持列表

|               芯片                |   解码单元名称   | H.264 | H.265 | VP9 | AV1 |
| :-------------------------------: | :--------------: | :---: | :---: | --- | --- |
|    Intel 8 代+ (AV1 需 11 代+)    | Intel Quick Sync |  ✅   |  ✅   | ✅  | ✅  |
| NVIDIA 10 系+ (AV1 需 RTX 30 系+) |      NVDEC       |  ✅   |  ✅   | ✅  | ✅  |
|  AMD RX 5000+ (AV1 需 RX 6000+)   |       VCN        |  ✅   |  ✅   | ✅  | ✅  |
|         Apple Silicon M1+         |  Apple 媒体引擎  |  ✅   |  ✅   | ❌  | ✅  |

### Web ▶️

输入视频 URL(https://example.com/video.mp4)时，浏览器会执行简单的内容协商：

1. 如果服务器发送了标准的 Content-Type(如 video/mp4)且文件编码为浏览器友好的编解码器(H.264/AAC)，它可能会播放
   - 但发送 Content-Disposition: attachment 头，强制浏览器将文件保存到磁盘而不是进行流式播放
   - 不支持流媒体协议
   - 像 MKV 这样的容器或特定的编码格式通常会导致标准浏览器标签页出现黑屏或“文件不支持”错误

## 编解码格式

### [H.264](./h264.md)
